#@draba/component-mongodb-task-manager

## 安装 ##

添加以下内容到package.json的dependencies

    "@draba/component-mongodb-task-manager":"git+ssh://git@git.oschina.net:DrabaFramework/component-mongodb-task-manager.git"

## 使用 ##

### 模块依赖 ###

第三方模块:

1.q@1

2.lodash@4

本地模块:

1.component/mongodb

2.config/mongodb_task_manager

### 使用模块 ###

#### 一个任务反复执行 ####

    /*config/mongodb_task_manager*/
    module.exports = {
        main: {
            mongodbInstanceName: 'main',
            collectionName: 'Task',
            taskType: 'example'
        }
    };

    /*feature/auto_run_task*/
    var Injector = require('draba-injector2');
    var uuid = require('uuid);
    var taskId = 'the_unique_task_id';
    module.exports = Injector.define([
        'component/mongodb_task_manager'
    ], createModule);
    function createModule(taskManagers) {
        var taskDelay = 10000;
        var taskTimeout = 10000;
        var managerId = uuid.v1();
        var TaskManager = taskManagers.main.TaskManager;
        var mainTaskManager = new TaskManager(managerId);
        var initBusinessData = {};
        var running = false;
        //提前需要将初始taskId的任务存入数据库,或者加上初始化脚本
        //初始化任务
        mainTaskManager.isEmpty().then(function (isEmpty) {
            if (isEmpty) {
                return mainTaskManager.newTask(taskId, taskDelay, initBusinessData);
            }
        });
        var runTask = function () {
            running = true;
            mainTaskManager.beginTask(taskId, taskTimeout).then(function (task) {
                if (!task) {
                    //fail to get task
                    return;
                }
                //run business task content
                //....
                var businessData = {};
                return mainTaskManager.endAndReNewTask(taskId, taskDelay, businessData).then(function () {
                    running = false;
                });
            });
        };
        setInterval(runTask, 5000);
    }
    
    
#### 多个任务顺序执行 ####
    
    /*config/mongodb_task_manager*/
    module.exports = {
        main: {
            mongodbInstanceName: 'main',
            collectionName: 'Task',
            taskType: 'example'
        }
    };

    /*feature/auto_run_task*/
    var Injector = require('draba-injector2');
    var uuid = require('uuid);
    var firstTaskId = 'the_first_task_id';
    module.exports = Injector.define([
        'component/mongodb_task_manager'
    ], createModule);
    function createModule(taskManagers) {
        var taskDelay = 10000;
        var taskTimeout = 10000;
        var managerId = uuid.v1();
        var TaskManager = taskManagers.main.TaskManager;
        var mainTaskManager = new TaskManager(managerId);
        var runTask = function () {
            tryBeginTheFocusTask(function (task) {
                if (!task) {
                    //no available task
                    return;
                }
                //run business task content
                //....
                return mainTaskManager.endAndReNewTask(task._id, taskDelay, {});
            });
        };
        setInterval(runTask, 5000);
    }


#### 多个任务并行 ####

不保证任务顺序性

    /*config/mongodb_task_manager*/
    module.exports = {
        main: {
            mongodbInstanceName: 'main',
            collectionName: 'Task',
            taskType: 'example'
        }
    };

    /*feature/auto_run_task*/
    var Injector = require('draba-injector2');
    var uuid = require('uuid);
    module.exports = Injector.define([
        'component/mongodb_task_manager'
    ], createModule);
    function createModule(taskManagers) {
        var taskDelay = 10000;
        var taskTimeout = 10000;
        var managerId = uuid.v1();
        var TaskManager = taskManagers.main.TaskManager;
        var mainTaskManager = new TaskManager(managerId);
        var taskLimit = 10;
        var running = false;
        var runTask = function () {
            running = true;
            return mainTaskManager.tryBeginAvailableTask(taskTimeout, taskLimit).then(function (task) {
                if (!task) {
                    //fail to get task
                    return;
                }
                //run business task content
                //....
                return mainTaskManager.endTask(task._id, taskDelay, {}).then(function () {
                    running = false;
                    runTask();
                });
            });
        };
        setInterval(runTask, 5000);
    }


## API ##

### TaskManager createTaskManager(string|integer managerId) ###

创建TaskManager实例

### Promise\<boolean isEmpty\> isEmpty() ###

查询任务列表是否为空

使用方法

    mainTaskManager.isEmpty().then(function (isEmpty) {
    });


### Promise\<Task task\> viewTask(string|integer taskId) ###

根据taskId查询单个任务的信息

使用方法

    mainTaskManager.viewTask(id).then(function (task) {
    })

### Promise\<Array\<Task\> tasks\> viewAvailableTasks(integer|undefined limit) ###

查询所有或部分可以执行的任务列表

使用方法:

    mainTaskManager.viewAvailableTasks(30).then(function (tasks) {
        //max 30 tasks
    })
    
    mainTaskManager.viewAvailableTasks().then(function (tasks) {
        //all tasks
    })
    
### Promise\<Task|undefined task\> viewAvailableEarliestTask() ###

查询最早的可以执行的任务

    mainTaskManager.viewAvailableEarliestTask().then(function (task) {
    })

### Promise\<Task|undefined task\> viewAvailableLatestTask() ###

查询最新的可以执行的任务

使用方法:

    mainTaskManager.viewAvailableLatestTask().then(function (task) {
    })
    
   
### Promise\<Task|undefined task\> viewLatestEndTask() ###

查询最新结束的任务

使用方法:

    mainTaskManager.viewLatestEndTask().then(function (task) {
    })


### Promise\<Array\<Task\> tasks\> viewTasks(integer|undefined limit) ###

查询所有或部分任务列表,时间正序(从早到晚)

使用方法:

    mainTaskManager.viewTasks(30).then(function (task) {
        //max 30 tasks
    })
    
    mainTaskManager.viewTasks().then(function (task) {
        //all tasks
    })


### Promise\<string|integer taskId\> newTask(string|integer taskId, integer\<millisenconds\> delay, any data) ###

新建任务

使用方法:

    var taskId = '111';
    var taskDelay = 30000;
    var data = {
        a: 'b'
    };
    mainTaskManager.newTask(taskId, taskDelay, data).then(function (taskId) {
        //taskId==='111'
    })


### Promise\<Task|undefined task\> beginTask(string|integer taskId, integer\<millisenconds\> timeout) ###

开始任务(抢任务),  task为undefined表示无法抢到任务, task有值表示抢到任务,接下来可以执行实际的业务

使用方法:

    var taskId = '111';
    var taskTimeout = 30000;
    var data = {
        a: 'b'
    };
    mainTaskManager.beginTask(taskId, taskTimeout, data).then(function (task) {
        /*
        task deep equal {
            _id: '111',
            taskType: ...,
            taskState: TASK_STATE.PENDING,
            expired: now + taskTimeout,
            data: {
                a: 'b'
            },
            managerId: ...
        }
        */
    })


### Promise\<Task|undefined task\> endTask(string|integer taskId, any data) ###

结束任务(交还任务), task为undefined表示任务不存在或任务已超时

使用方法:

    var taskId = '111';
    var data = {
        a: 'b'
    };
    mainTaskManager.endTask(taskId, data).then(function (task) {
        /*
        task deep equal {
            _id: '111',
            taskType: ...,
            taskState: TASK_STATE.END,
            expired: now,
            data: {
                a: 'b'
            }
        }
        */
    })


### Promise\<Task|undefined task\> endAndAssignNextTask(string|integer taskId, string|integer nextTaskId, any data) ###

与endTask的区别在于指定任务结束后会指定下一个任务的ID, 以便串行执行任务

使用方法:

    var taskId = '111';
    var nextTaskId = '222';
    var data = {
        a: 'b'
    };
    mainTaskManager.endAndAssignNextTask(taskId, nextTaskId, data).then(function (task) {
        /*
        task deep equal {
            _id: '111',
            taskType: ...,
            taskState: TASK_STATE.END,
            expired: now,
            data: {
                a: 'b'
            },
            nextTaskId: '222'
        }
        */
    })

### Promise\<Task|undefined task\> endAndReNewTask(string|integer taskId, integer\<millisenconds\> delay, any data) ###

与endTask的区别在于会更新当前任务为新任务,以便一个任务重复执行

使用方法:

    
    var taskId = '111';
    var taskDelay = 30000;
    var data = {
        a: 'b'
    };
    mainTaskManager.endAndReNewTask(taskId, taskDelay, data).then(function (task) {
        /*
        task deep equal {
            _id: '111',
            taskType: ...,
            taskState: TASK_STATE.RENEW,
            expired: now + taskDelay,
            data: {
                a: 'b'
            }
        }
        */
    })


